<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Persistent Notion Timer</title>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
:root {
  --text: #141414;
  --subtext: #333333;
  --bar-bg: #e6d9fa;
  --bar-fill: #9b5cf6;
  --button-bg: #9b5cf6;
  --icon-color: #141414;
  
  /* Responsive sizing variables */
  --base-size: clamp(8px, 2.5vw, 16px);
  --spacing: clamp(8px, 2vw, 20px);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0b0b0b;
    --card: #121212;
    --text: #e9e9e9;
    --subtext: #f1f1f1;
    --icon-color: #e9e9e9;
  }
}

    * { box-sizing: border-box; }
html {
  background: transparent;
}
body {
  margin: 0;
  background: transparent;
  color: var(--text);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: clamp(4px, 1vw, 8px);
}
.card {
  background: var(--card);
  border-radius: 20px;
  padding: clamp(12px, 3vw, 40px);
  width: 100%;
  max-width: 100%;
  clip-path: none !important;
  box-sizing: border-box;
}



    .loading {
      opacity: 0.5;
      pointer-events: none;
    }


.icon-btn {
  cursor: pointer;
  user-select: none;
  padding: clamp(3px, 1vw, 6px);
  border-radius: clamp(4px, 1.5vw, 8px);
  transition: background 0.2s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(20px, 6vw, 34px);
  color: var(--button-bg);
}


    .icon-btn:hover {
      background: var(--bar-bg);
    }

   .settings-btn {
  font-size: clamp(16px, 4.5vw, 22px);
  cursor: pointer;
  padding: clamp(3px, 1vw, 6px);
  border-radius: clamp(4px, 1.5vw, 8px);
  transition: all 0.2s;
  opacity: 0.4;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--button-bg);
}

    @media (min-width: 640px) {
      .settings-btn {
        font-size: 20px;
      }
    }

    .settings-btn:hover {
      background: var(--bar-bg);
      opacity: 0.8;
    }


.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(0.25vw, 1fr));
  gap: clamp(10px, 4vw, 26px);
  margin-bottom: 0px;
}

    .unit {
      text-align: left;
      display: none;
    }

    .unit.visible {
      display: block;
    }

.num-container {
  font-family: 'Nunito';
  font-weight: 900;
  font-size: clamp(24px, 7vw, 40px);
  margin-bottom: clamp(-5px, -1vw, -7px);
  display: flex;
}

    .digit {
      display: inline-block;
      position: relative;
      width: 0.6em;
      text-align: center;
      overflow: hidden;
      height: 1.2em;
    }

    .digit-inner {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.6s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity 0.3s;
    }

    .digit.flipping .digit-inner.old {
      animation: slideUp 0.6s ease-in-out forwards;
    }

    .digit.flipping .digit-inner.new {
      animation: slideDown 0.6s ease-in-out forwards;
    }

    @keyframes slideUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-100%); opacity: 0; }
    }

    @keyframes slideDown {
      0% { transform: translateY(100%); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
.label {
  font-family: 'Nunito';
  font-size: clamp(12px, 3.5vw, 20px);
  font-weight: 500;
  color: var(--subtext);
}

 .bar {
  height: clamp(10px, 3vw, 16px);
  background: var(--bar-bg);
  border-radius: clamp(6px, 2vw, 10px);
  overflow: hidden;
  position: relative;
}

.bar.rounded-bar {
  height: clamp(10px, 3vw, 20px);
  border-radius: clamp(12px, 3vw, 20px);
}

.bar.thin-bar {
  height: clamp(5px, 1.875vw, 10px);
  border-radius: clamp(2px, 1vw, 4px);
}

.bar.square-bar {
  height: clamp(12px, 3.2vw, 20px);
  border-radius: clamp(3px, 1vw, 5px);
}

.fill {
  height: 100%;
  background: var(--bar-fill);
  width: 0%;
  transition: width 1s linear;
  position: relative;
}

.bar.rounded-bar .fill {
  border-radius: 20px;
}

.bar.thin-bar .fill {
  border-radius: 4px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

.bar.square-bar .fill {
  border-radius: 5px;
}


    .fill.wave {
      background: linear-gradient(90deg, 
        var(--bar-fill) 0%, 
        var(--bar-fill) 40%,
        color-mix(in srgb, var(--bar-fill) 80%, white) 50%,
        var(--bar-fill) 60%,
        var(--bar-fill) 100%
      );
      background-size: 200% 100%;
      animation: wave 2s ease-in-out infinite;
    }

    @keyframes wave {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .fill.glow::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 30px;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4));
      animation: glow 1.5s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    .fill.gradient {
      background: linear-gradient(90deg, 
        color-mix(in srgb, var(--bar-fill) 70%, black),
        var(--bar-fill),
        color-mix(in srgb, var(--bar-fill) 70%, white)
      );
    }

    .fill.shimmer {
      background: var(--bar-fill);
      position: relative;
      overflow: hidden;
    }

    .fill.shimmer::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .fill.pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { 
        box-shadow: 0 0 5px var(--bar-fill);
        filter: brightness(1);
      }
      50% { 
        box-shadow: 0 0 15px var(--bar-fill);
        filter: brightness(1.2);
      }
    }

.bar-percentage {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(8px, 2.2vw, 12px);
  font-weight: 600;
  color: var(--text);
  z-index: 10;
  pointer-events: none;
  opacity: 0.8;
  text-shadow: 0 0 3px var(--card);
}

.footer {
  margin-top: clamp(8px, 2vw, 16px);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: clamp(10px, 2.5vw, 13px);
  color: var(--subtext);
  gap: clamp(6px, 2vw, 12px);
}

    .footer span {
      flex-shrink: 0;
    }

    .title-left {
      display: flex;

      flex: 1;
      min-width: 0;
    }

.title-left input {
  background: transparent;
  border: none;
  color: var(--text);
  flex: 1;
  min-width: 0;
  max-width: clamp(120px, 35vw, 250px);
  outline: none;
  padding: clamp(2px, 1vw, 4px) clamp(4px, 1.5vw, 8px);
  border-radius: clamp(3px, 1vw, 6px);
  font-size: clamp(14px, 4vw, 21px);
  font-family: 'Nunito';
  font-weight: 600;
}

    .title-left input:focus {
      background: var(--bar-bg);
    }



    .footer-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title-center {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      justify-content: center;
      min-width: 0;
    }

    .title-center input {
      background: transparent;
      border: none;
      color: var(--text);
      text-align: center;
      min-width: 0;
      max-width: 200px;
      outline: none;
      padding: 4px 8px;
      border-radius: 6px;
    }

    @media (min-width: 640px) {
      .title-center input {
        font-size: 18px;
        max-width: 250px;
      }
    }

    .title-center input:focus {
      background: var(--bar-bg);
    }

    .title-center .icon-btn {
      font-size: 20px;
      padding: 4px;
    }

    @media (min-width: 640px) {
      .title-center .icon-btn {
        font-size: 24px;
      }
    }

    .title-center {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      justify-content: center;
      min-width: 0;
    }

    .title-center input {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      min-width: 0;
      max-width: 200px;
      outline: none;
      padding: 4px 8px;
      border-radius: 6px;
    }

    @media (min-width: 640px) {
      .title-center input {
        font-size: 18px;
        max-width: 250px;
      }
    }

    .title-center input:focus {
      background: var(--bar-bg);
    }

    .title-center .icon-btn {
      font-size: 20px;
      padding: 4px;
    }

    @media (min-width: 640px) {
      .title-center .icon-btn {
        font-size: 24px;
      }
    }

.action-btn {
  padding: clamp(5px, 1.5vw, 8px) clamp(10px, 3vw, 20px);
  border: clamp(1px, 0.3vw, 1.5px) solid var(--bar-fill);
  border-radius: clamp(12px, 3vw, 20px);
  background: transparent;
  color: var(--bar-fill);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: clamp(10px, 2.5vw, 13px);
  opacity: 0.7;
  white-space: nowrap;
  flex-shrink: 0;
}

    .action-btn:hover {
      opacity: 1;
      background: var(--bar-fill);
      color: white;
      transform: translateY(-1px);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .action-btn.running {
      border-color: var(--subtext);
      color: var(--subtext);
    }

    .action-btn.running:hover {
      background: var(--subtext);
      color: white;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(155, 92, 246, 0.6); }
      70% { box-shadow: 0 0 0 12px rgba(155, 92, 246, 0); }
      100% { box-shadow: 0 0 0 0 rgba(155, 92, 246, 0); }
    }

    .card.pulse {
      animation: pulse 0.9s ease-out;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 16px;
    }

    @media (min-width: 640px) {
      .modal {
        padding: 20px;
      }
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
    }

    @media (min-width: 640px) {
      .modal-content {
        padding: 24px;
        max-height: 80vh;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    @media (min-width: 640px) {
      .modal-header {
        margin-bottom: 20px;
      }
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
    }

    @media (min-width: 640px) {
      .modal-header h2 {
        font-size: 20px;
      }
    }

    .close-btn {
      font-size: 28px;
      cursor: pointer;
      opacity: 0.6;
      line-height: 1;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      max-height: 250px;
      overflow-y: auto;
    }

    @media (min-width: 480px) {
      .emoji-grid {
        grid-template-columns: repeat(8, 1fr);
        gap: 8px;
        max-height: 300px;
      }
    }

    .emoji-item {
      font-size: 24px;
      padding: 6px;
      cursor: pointer;
      border-radius: 8px;
      text-align: center;
      transition: background 0.2s;
      color: var(--button-bg); /* This colors the icons in the selector menu */
    }

    @media (min-width: 640px) {
      .emoji-item {
        font-size: 28px;
        padding: 8px;
      }
    }

    .emoji-item:hover {
      background: var(--bar-bg);
    }

    .setting-group {
      margin-bottom: 20px;
    }

    @media (min-width: 640px) {
      .setting-group {
        margin-bottom: 24px;
      }
    }

    .setting-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    @media (min-width: 640px) {
      .setting-group label {
        font-size: 14px;
      }
    }

    .setting-group select {
      width: 100%;
      padding: 9px;
      border: 2px solid var(--bar-bg);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }

    @media (min-width: 640px) {
      .setting-group select {
        padding: 10px;
        font-size: 14px;
      }
    }

    .palette-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 14px;
    }

    @media (min-width: 480px) {
      .palette-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 16px;
      }
    }

    .palette-card {
      padding: 14px;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s;
    }

    @media (min-width: 640px) {
      .palette-card {
        padding: 16px;
      }
    }

    .palette-card:hover {
      transform: translateY(-2px);
    }

    .palette-card.selected {
      border-color: var(--text);
    }

    .palette-name {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 13px;
    }

    @media (min-width: 640px) {
      .palette-name {
        font-size: 14px;
      }
    }

    .palette-colors {
      display: flex;
      gap: 6px;
      margin-bottom: 4px;
    }

    .palette-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
    }

.edit-palette-btn {
  margin-top: 8px;
  padding: 6px 12px;
  border: 1.5px solid var(--bar-fill);
  border-radius: 12px;
  background: transparent;
  color: var(--bar-fill);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
}

.edit-palette-btn:hover {
  background: var(--bar-fill);
  color: white;
}

.palette-editor-grid {
  display: grid;
  gap: 16px;
  margin-top: 16px;
}

.mode-section {
  padding: 16px;
  border: 2px solid var(--bar-bg);
  border-radius: 12px;
}

.mode-section h3 {
  margin: 0 0 12px 0;
  font-size: 14px;
  color: var(--text);
}

    @media (min-width: 640px) {
      .palette-dot {
        width: 20px;
        height: 20px;
      }
    }

    .error-message {
      background: #ff4444;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 13px;
      display: none;
    }

    @media (min-width: 640px) {
      .error-message {
        padding: 12px;
        margin-top: 12px;
        font-size: 14px;
      }
    }

    .error-message.show {
      display: block;
    }


  </style>
</head>
<body>
  <div class="card" id="card" style="border-radius: 20px;">


    <div class="grid">
      <div class="unit" id="dayUnit">
        <div class="num-container" id="day"></div>
        <div class="label">days</div>
        <div class="bar rounded-bar"><div class="fill wave" id="dayBar"></div></div>
      </div>
      <div class="unit" id="hrUnit">
        <div class="num-container" id="hr"></div>
        <div class="label">hours</div>
        <div class="bar rounded-bar"><div class="fill wave" id="hrBar"></div></div>
      </div>
      <div class="unit" id="minUnit">
        <div class="num-container" id="min"></div>
        <div class="label">minutes</div>
        <div class="bar rounded-bar"><div class="fill wave" id="minBar"></div></div>
      </div>
      <div class="unit" id="secUnit">
        <div class="num-container" id="sec"></div>
        <div class="label">seconds</div>
        <div class="bar rounded-bar"><div class="fill wave" id="secBar"></div></div>
      </div>
    </div>

    <div class="footer">
      <div class="title-left">
        <span class="icon-btn" id="iconBtn"><i class="ph-fill ph-timer"></i></span>
        <input type="text" id="titleInput" value="Timer" placeholder="Enter name...">
      </div>
      
      <div class="footer-right">
        <span class="settings-btn" id="settingsBtn"><i class="ph-fill ph-gear-six"></i></span>
        <button class="action-btn" id="actionBtn" disabled>Loading...</button>
      </div>
    </div>
    <div class="error-message" id="errorMessage"></div>
  </div>

  <div class="modal" id="emojiModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Choose Icon</h2>
        <span class="close-btn" id="closeEmoji">√ó</span>
      </div>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>
  </div>
<div class="modal" id="paletteEditorModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="paletteEditorTitle">Edit Palette</h2>
      <span class="close-btn" id="closePaletteEditor">√ó</span>
    </div>
    
    <div class="palette-editor-grid">
      <div class="mode-section">
        <h3>‚òÄÔ∏è Light Mode Colors</h3>
        <div class="color-input-row">
          <label>Progress Background</label>
          <input type="color" id="lightBarBg">
        </div>
        <div class="color-input-row">
          <label>Progress Fill</label>
          <input type="color" id="lightBarFill">
        </div>
        <div class="color-input-row">
          <label>Button</label>
          <input type="color" id="lightButton">
        </div>
      </div>
      
      <div class="mode-section">
        <h3>üåô Dark Mode Colors</h3>
        <div class="color-input-row">
          <label>Progress Background</label>
          <input type="color" id="darkBarBg">
        </div>
        <div class="color-input-row">
          <label>Progress Fill</label>
          <input type="color" id="darkBarFill">
        </div>
        <div class="color-input-row">
          <label>Button</label>
          <input type="color" id="darkButton">
        </div>
      </div>
    </div>
    
    <button class="action-btn" id="savePaletteBtn" style="width: 100%; margin-top: 16px;">Save Palette</button>
  </div>
</div>
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <span class="close-btn" id="closeSettings">√ó</span>
      </div>

      <div class="setting-group">
        <label>Color Palette</label>
        <div class="palette-grid" id="paletteGrid"></div>
      </div>

      <div class="setting-group">
        <label>Number Animation</label>
        <select id="numberAnim">
          <option value="flip">Slide Animation</option>
          <option value="none">None</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Progress Bar Shape</label>
        <select id="barShape">
          <option value="rounded-bar">Rounded Bar (Default)</option>
          <option value="thin-bar">Thin Bar</option>
          <option value="square-bar">Square Bar</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Progress Bar Style</label>
        <select id="barStyle">
          <option value="wave">Wave</option>
          <option value="glow">Glow</option>
          <option value="gradient">Gradient</option>
          <option value="shimmer">Shimmer</option>
          <option value="pulse-glow">Pulse Glow</option>
          <option value="smooth">Simple</option>
        </select>
      </div>

<div class="setting-group">
  <label>Card Corner Roundness</label>
  <select id="cornerPreset">
    <option value="8">Slightly Rounded</option>
    <option value="20">Default Rounded</option>
    <option value="40">Really Rounded</option>
    <option value="custom">Custom...</option>
  </select>
</div>

<div class="setting-group" id="customRadiusGroup" style="display: none;">
  <label>Custom Radius (0-50px)</label>
  <input type="number" id="customRadius" min="0" max="50" value="20" style="width: 100%; padding: 10px; border: 2px solid var(--bar-bg); border-radius: 8px; background: var(--bg); color: var(--text);">
</div>

      <div class="setting-group">
        <label>Font Size</label>
        <select id="fontSize">
          <option value="40px">Normal (Default)</option>
          <option value="20px">Small</option>
          <option value="48px">Large</option>
          <option value="56px">Extra Large</option>
        </select>
      </div>
      <div class="setting-group">
        <label>Visible Time Units</label>
        <div style="display: grid; gap: 8px; padding: 10px; background: var(--bg); border-radius: 8px; border: 2px solid var(--bar-bg);">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showDays" style="width: 18px; height: 18px; cursor: pointer;">
            <span>Show Days</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showHours" style="width: 18px; height: 18px; cursor: pointer;">
            <span>Show Hours</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showMinutes" style="width: 18px; height: 18px; cursor: pointer;">
            <span>Show Minutes</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showSeconds" style="width: 18px; height: 18px; cursor: pointer;">
            <span>Show Seconds</span>
          </label>
  <label>Show Progress Percentage</label>
  <select id="showPercentage">
    <option value="false">Hidden (Default)</option>
    <option value="true">Show Inside Bar</option>
  </select>
</div>

      <div class="setting-group">
        <label>Custom Start Date</label>
        <input type="datetime-local" id="customStartDate" style="width: 100%; padding: 10px; border: 2px solid var(--bar-bg); border-radius: 8px; background: var(--bg); color: var(--text); margin-bottom: 10px;">
        <button class="action-btn" id="syncDateBtn" style="width: 100%;">Sync Date to Firebase</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* ================================
       1. FIREBASE CONFIG
       ================================ */
    const firebaseConfig = {
      apiKey: "AIzaSyClohsSAkMTeYCqq_PRK_F5aSfpPupTaJM",
      authDomain: "notion-persistent-timer.firebaseapp.com",
      projectId: "notion-persistent-timer",
      storageBucket: "notion-persistent-timer.firebasestorage.app",
      messagingSenderId: "358621702162",
      appId: "1:358621702162:web:127f2c1fb57e9e1f0390cb"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const timerRef = db.collection("timers").doc("notionTimer");

    /* ================================
   /* ================================
       2. UI STATE
       ================================ */
    const phosphorIcons = [
      'tier', 'clock', 'hourglass', 'alarm', 
      'calendar', 'heart', 'star', 'fire', 'lightning', 
      'trophy', 'target', 'flag', 'leaf', 'tree', 
      'sun', 'moon', 'cloud', 'drop', 'atom', 
      'brain', 'barbell', 'coffee', 'briefcase', 'potted-plant'
    ];

const palettes = [
  { 
    name: 'Purple Dream', 
    light: { barBg: '#e6d9fa', barFill: '#9b5cf6', button: '#9b5cf6' },
    dark: { barBg: '#4a1f7a', barFill: '#b084cc', button: '#b084cc' }
  },
  { 
    name: 'Pink Paradise', 
    light: { barBg: '#ffd3e1', barFill: '#ff6b9d', button: '#ff4081' },
    dark: { barBg: '#6b2d41', barFill: '#ff8fa3', button: '#ff6b8a' }
  },
  { 
    name: 'Ocean Blue', 
    light: { barBg: '#d3e9ff', barFill: '#4a90e2', button: '#2e7dd9' },
    dark: { barBg: '#1a3a5c', barFill: '#5da3f0', button: '#4a90e2' }
  },
  { 
    name: 'Mint Fresh', 
    light: { barBg: '#d3f5e6', barFill: '#4ecdc4', button: '#3ab8af' },
    dark: { barBg: '#1f4a42', barFill: '#5eddd4', button: '#4ecdc4' }
  },
  { 
    name: 'Sunset Orange', 
    light: { barBg: '#ffe5d3', barFill: '#ff8a5b', button: '#ff6b35' },
    dark: { barBg: '#5c3320', barFill: '#ff9a6b', button: '#ff8a5b' }
  },
  { 
    name: 'Golden Hour', 
    light: { barBg: '#fff4d3', barFill: '#ffd93d', button: '#ffc107' },
    dark: { barBg: '#5c4f1a', barFill: '#ffe74d', button: '#ffd93d' }
  },
  { 
    name: 'Forest Green', 
    light: { barBg: '#d8f3dc', barFill: '#52b788', button: '#40916c' },
    dark: { barBg: '#1f3d2e', barFill: '#62c798', button: '#52b788' }
  },
  { 
    name: 'Lavender Dream', 
    light: { barBg: '#e8d9f5', barFill: '#b084cc', button: '#9b59b6' },
    dark: { barBg: '#3d2952', barFill: '#c094dc', button: '#b084cc' }
  },
  { 
    name: 'Rose Gold', 
    light: { barBg: '#fde8e9', barFill: '#e8a0a6', button: '#d87c82' },
    dark: { barBg: '#5c2e32', barFill: '#f8b0b6', button: '#e8a0a6' }
  },
  { 
    name: 'Coral Reef', 
    light: { barBg: '#ffe8e1', barFill: '#ff8f7a', button: '#ff6b54' },
    dark: { barBg: '#5c2e26', barFill: '#ff9f8a', button: '#ff8f7a' }
  }
];

let state = {
  title: "Timer",
  icon: '<i class="ph-fill ph-timer"></i>',
  selectedPalette: 0,
  palettes: palettes, // Store customized palettes
  numberAnim: "flip",
  barStyle: "wave",
  barShape: "rounded-bar",
  cornerRadius: 20,
  fontSize: "40px",
  customDate: "",
  showPercentage: false,
  visibleUnits: {
    day: true,
    hr: true,
    min: true,
    sec: true
  }
};
    let startTime = null;
   let prevValues = { day: '', hr: '', min: '', sec: '' };
    let isOperating = false; // Prevent concurrent operations

    /* ================================
       3. UI ELEMENTS
       ================================ */
    const actionBtn = document.getElementById("actionBtn");
    const titleInput = document.getElementById("titleInput");
    const iconBtn = document.getElementById("iconBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const card = document.getElementById("card");
    const emojiModal = document.getElementById("emojiModal");
    const settingsModal = document.getElementById("settingsModal");
    const emojiGrid = document.getElementById("emojiGrid");
    const paletteGrid = document.getElementById("paletteGrid");
    const errorMessage = document.getElementById("errorMessage");


    /* ================================
   4.5. DARK MODE DETECTION
   ================================ */
function isDarkMode() {
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

function getCurrentPaletteColors() {
  const palette = state.palettes[state.selectedPalette];
  const mode = isDarkMode() ? 'dark' : 'light';
  return palette[mode];
}


    /* ================================
       4. ERROR HANDLING
       ================================ */
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }

    /* ================================
       5. EMOJI PICKER
       ================================ */
    /* ================================
       5. ICON PICKER
       ================================ */
    phosphorIcons.forEach(iconName => {
      const div = document.createElement('div');
      div.className = 'emoji-item';
      // This creates the actual visual icon in the grid
      div.innerHTML = `<i class="ph-fill ph-${iconName}"></i>`;
      
      div.onclick = () => {
        // This saves the HTML code for the icon into your settings
        const iconHtml = `<i class="ph-fill ph-${iconName}"></i>`;
        state.icon = iconHtml;
        iconBtn.innerHTML = iconHtml;
        emojiModal.classList.remove('show');
        saveSettings();
      };
      emojiGrid.appendChild(div);
    });

    /* ================================
       6. PALETTE PICKER
       ================================ */
function renderPaletteGrid() {
  paletteGrid.innerHTML = ''; // Clear existing
  
  state.palettes.forEach((palette, idx) => {
    const div = document.createElement('div');
    div.className = 'palette-card';
    if (idx === state.selectedPalette) div.classList.add('selected');
    
    const colors = getCurrentPaletteColors();
    div.style.background = colors.barBg;
    
    div.innerHTML = `
      <div class="palette-name" style="color: ${colors.button}">${palette.name}</div>
      <div class="palette-colors">
        <div class="palette-dot" style="background: ${colors.barBg}"></div>
        <div class="palette-dot" style="background: ${colors.barFill}"></div>
        <div class="palette-dot" style="background: ${colors.button}"></div>
      </div>
      <button class="edit-palette-btn" data-index="${idx}">‚úé Edit Colors</button>
    `;
    
    div.onclick = (e) => {
      if (e.target.classList.contains('edit-palette-btn')) {
        e.stopPropagation();
        openPaletteEditor(idx);
        return;
      }
      
      state.selectedPalette = idx;
      applyCurrentPalette();
      
      document.querySelectorAll('.palette-card').forEach(c => c.classList.remove('selected'));
      div.classList.add('selected');
      
      saveSettings();
    };
    
    paletteGrid.appendChild(div);
  });
}

renderPaletteGrid();
    /* ================================
       7. MODAL HANDLERS
       ================================ */
    iconBtn.onclick = () => emojiModal.classList.add('show');
    settingsBtn.onclick = () => settingsModal.classList.add('show');
    document.getElementById('closeEmoji').onclick = () => emojiModal.classList.remove('show');
    document.getElementById('closeSettings').onclick = () => settingsModal.classList.remove('show');

    emojiModal.onclick = (e) => {
      if (e.target === emojiModal) emojiModal.classList.remove('show');
    };
    settingsModal.onclick = (e) => {
      if (e.target === settingsModal) settingsModal.classList.remove('show');
    };

    /* ================================
       8. SETTINGS HANDLERS
       ================================ */
/* ================================
       8. SETTINGS HANDLERS
       ================================ */
    const numberAnim = document.getElementById('numberAnim');
    const barStyle = document.getElementById('barStyle');
    const barShape = document.getElementById('barShape');
    const fontSize = document.getElementById('fontSize');
    
    const paletteEditorModal = document.getElementById('paletteEditorModal');
    const paletteEditorTitle = document.getElementById('paletteEditorTitle');
    const closePaletteEditor = document.getElementById('closePaletteEditor');
    const savePaletteBtn = document.getElementById('savePaletteBtn');
    
    let editingPaletteIndex = null;

    function applyCurrentPalette() {
      const colors = getCurrentPaletteColors();
      document.documentElement.style.setProperty('--bar-bg', colors.barBg);
      document.documentElement.style.setProperty('--bar-fill', colors.barFill);
      document.documentElement.style.setProperty('--button-bg', colors.button);
    }
    
    function openPaletteEditor(index) {
      editingPaletteIndex = index;
      const palette = state.palettes[index];
      
      paletteEditorTitle.textContent = `Edit ${palette.name}`;
      
      // Load light mode colors
      document.getElementById('lightBarBg').value = palette.light.barBg;
      document.getElementById('lightBarFill').value = palette.light.barFill;
      document.getElementById('lightButton').value = palette.light.button;
      
      // Load dark mode colors
      document.getElementById('darkBarBg').value = palette.dark.barBg;
      document.getElementById('darkBarFill').value = palette.dark.barFill;
      document.getElementById('darkButton').value = palette.dark.button;
      
      paletteEditorModal.classList.add('show');
    }
    
    closePaletteEditor.onclick = () => paletteEditorModal.classList.remove('show');
    paletteEditorModal.onclick = (e) => {
      if (e.target === paletteEditorModal) paletteEditorModal.classList.remove('show');
    };
    
    savePaletteBtn.onclick = () => {
      if (editingPaletteIndex === null) return;
      
      const palette = state.palettes[editingPaletteIndex];
      
      // Save light mode colors
      palette.light.barBg = document.getElementById('lightBarBg').value;
      palette.light.barFill = document.getElementById('lightBarFill').value;
      palette.light.button = document.getElementById('lightButton').value;
      
      // Save dark mode colors
      palette.dark.barBg = document.getElementById('darkBarBg').value;
      palette.dark.barFill = document.getElementById('darkBarFill').value;
      palette.dark.button = document.getElementById('darkButton').value;
      
      // If this is the currently selected palette, apply changes immediately
      if (editingPaletteIndex === state.selectedPalette) {
        applyCurrentPalette();
      }
      
      renderPaletteGrid();
      saveSettings();
      paletteEditorModal.classList.remove('show');
    };
    
    // Listen for system theme changes
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        applyCurrentPalette();
        renderPaletteGrid();
      });
    }
    numberAnim.onchange = (e) => {
      state.numberAnim = e.target.value;
      saveSettings();
    };
    
barStyle.onchange = (e) => {
  state.barStyle = e.target.value;
  document.querySelectorAll('.fill').forEach(fill => {
    fill.className = 'fill';
    if (e.target.value !== 'smooth') fill.classList.add(e.target.value);
  });
  saveSettings();
};

barShape.onchange = (e) => {
  state.barShape = e.target.value;
  
  // Reset all bars and remove inline styles
  document.querySelectorAll('.bar').forEach(bar => {
    // Clear inline styles that might be stuck
    bar.style.background = '';
    
    // Reset classes
    bar.className = 'bar';
    bar.classList.add(e.target.value);
    
    // Reset fill element
    const fill = bar.querySelector('.fill');
    if (fill) {
      fill.className = 'fill';
      fill.style.width = ''; // Clear any stuck width
      
      // Reapply the bar style
      if (state.barStyle !== 'smooth') {
        fill.classList.add(state.barStyle);
      }
    }
  });
  
  saveSettings();
};


const cornerPreset = document.getElementById('cornerPreset');
const customRadius = document.getElementById('customRadius');
const customRadiusGroup = document.getElementById('customRadiusGroup');

cornerPreset.onchange = (e) => {
  if (e.target.value === 'custom') {
    customRadiusGroup.style.display = 'block';
    state.cornerRadius = parseInt(customRadius.value);
  } else {
    customRadiusGroup.style.display = 'none';
    state.cornerRadius = parseInt(e.target.value);
  }
  applyCornerShape();
  saveSettings();
};

customRadius.oninput = (e) => {
  state.cornerRadius = parseInt(e.target.value);
  applyCornerShape();
  saveSettings();
};

function applyCornerShape() {
  card.style.borderRadius = state.cornerRadius + 'px';
}
    fontSize.onchange = (e) => {
      state.fontSize = e.target.value;
      document.querySelectorAll('.num-container').forEach(num => num.style.fontSize = e.target.value);
      saveSettings();
    };
const showPercentage = document.getElementById('showPercentage');

showPercentage.onchange = (e) => {
  state.showPercentage = e.target.value === 'true';
  saveSettings();
};

// Column visibility controls
    const showDays = document.getElementById('showDays');
    const showHours = document.getElementById('showHours');
    const showMinutes = document.getElementById('showMinutes');
    const showSeconds = document.getElementById('showSeconds');
    
    showDays.onchange = (e) => {
      state.visibleUnits.day = e.target.checked;
      saveSettings();
    };
    
    showHours.onchange = (e) => {
      state.visibleUnits.hr = e.target.checked;
      saveSettings();
    };
    
    showMinutes.onchange = (e) => {
      state.visibleUnits.min = e.target.checked;
      saveSettings();
    };
    
    showSeconds.onchange = (e) => {
      state.visibleUnits.sec = e.target.checked;
      saveSettings();
    };

    titleInput.oninput = () => {
      state.title = titleInput.value;
      saveSettings();
    };
const customDateInput = document.getElementById('customStartDate');
    const syncDateBtn = document.getElementById('syncDateBtn');

    syncDateBtn.onclick = async () => {
      const selectedValue = customDateInput.value;
      if (!selectedValue) {
        showError("Please select a date first!");
        return;
      }

      // Convert selected date to milliseconds for Firebase
      const newStartTime = new Date(selectedValue).getTime();
      
      try {
        syncDateBtn.disabled = true;
        syncDateBtn.textContent = "Syncing...";
        
        // Update both the startTime and the settings.customDate in Firebase
        await timerRef.update({
          startTime: newStartTime,
          "settings.customDate": selectedValue
        });
        
        // Update local state so the timer changes immediately
        startTime = newStartTime;
        state.customDate = selectedValue;
        
        syncDateBtn.textContent = "Synced!";
        setTimeout(() => { 
          syncDateBtn.textContent = "Sync Date to Firebase"; 
          syncDateBtn.disabled = false; 
        }, 2000);
      } catch (err) {
        showError("Failed to sync date. Check connection.");
        syncDateBtn.disabled = false;
        syncDateBtn.textContent = "Sync Date to Firebase";
      }
    };
    /* ================================
       9. SAVE SETTINGS TO FIREBASE
       ================================ */
    let saveTimeout;
    async function saveSettings() {
      // Debounce saves to avoid too many writes
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        try {
          await timerRef.update({
            settings: state
          });
        } catch (err) {
          console.error("Failed to save settings:", err);
        }
      }, 500);
    }

    /* ================================
       10. APPLY SETTINGS TO UI
       ================================ */
function applySettings() {
  titleInput.value = state.title;
  iconBtn.innerHTML = state.icon;
  
  // Apply the current palette colors
  applyCurrentPalette();
      
numberAnim.value = state.numberAnim;
barStyle.value = state.barStyle;
barShape.value = state.barShape;
// Set corner radius
if ([8, 20, 40].includes(state.cornerRadius)) {
  cornerPreset.value = state.cornerRadius;
  customRadiusGroup.style.display = 'none';
} else {
  cornerPreset.value = 'custom';
  customRadius.value = state.cornerRadius;
  customRadiusGroup.style.display = 'block';
}
applyCornerShape();
fontSize.value = state.fontSize;
showPercentage.value = state.showPercentage ? 'true' : 'false';
     
// Apply column visibility settings
      if (state.visibleUnits) {
        document.getElementById('showDays').checked = state.visibleUnits.day;
        document.getElementById('showHours').checked = state.visibleUnits.hr;
        document.getElementById('showMinutes').checked = state.visibleUnits.min;
        document.getElementById('showSeconds').checked = state.visibleUnits.sec;
      }

      // Apply bar style
      document.querySelectorAll('.fill').forEach(fill => {
        fill.className = 'fill';
        if (state.barStyle !== 'smooth') fill.classList.add(state.barStyle);
      });
      
// Apply bar style
document.querySelectorAll('.fill').forEach(fill => {
  fill.className = 'fill';
  if (state.barStyle !== 'smooth') fill.classList.add(state.barStyle);
});

// Apply bar shape
document.querySelectorAll('.bar').forEach(bar => {
  // Clear any inline styles first
  bar.style.background = '';
  
  // Reset bar classes
  bar.className = 'bar';
  bar.classList.add(state.barShape);
  
  // Reset fill element
  const fill = bar.querySelector('.fill');
  if (fill) {
    fill.className = 'fill';
    fill.style.width = '';
    
    // Reapply bar style to fill
    if (state.barStyle !== 'smooth') {
      fill.classList.add(state.barStyle);
    }
  }
});
      
      // Apply corner shape
      applyCornerShape();
      
      // Apply font size
      document.querySelectorAll('.num-container').forEach(num => num.style.fontSize = state.fontSize);
      
      // Update selected palette
      document.querySelectorAll('.palette-card').forEach((c, idx) => {
        c.classList.remove('selected');
        if (idx === state.selectedPalette) {
          c.classList.add('selected');
        }
      });

      // Update the date picker input with the saved date from Firebase
      if (state.customDate) {
        document.getElementById('customStartDate').value = state.customDate;
      }
    }

    /* ================================
       11. FIREBASE FUNCTIONS
       ================================ */
    async function loadTimer() {
      card.classList.add('loading');
      try {
        const doc = await timerRef.get();
        
        if (doc.exists) {
          const data = doc.data();
          
          // Load timer
          if (data.startTime) {
            startTime = data.startTime;
            actionBtn.textContent = "‚Ü∫";
            actionBtn.classList.add("running");
          } else {
            actionBtn.textContent = "Start";
            actionBtn.classList.remove("running");
          }
          
          // Load settings
          if (data.settings) {
            state = { ...state, ...data.settings };
            applySettings();
          }
        } else {
          actionBtn.textContent = "Start";
          actionBtn.classList.remove("running");
        }
      } catch (err) {
        console.error("Failed to load timer:", err);
        showError("Failed to load timer. Please refresh the page.");
        actionBtn.textContent = "Start";
        actionBtn.classList.remove("running");
      } finally {
        card.classList.remove('loading');
        actionBtn.disabled = false;
      }
    }

    async function startTimer() {
      if (startTime !== null || isOperating) return;
      
      isOperating = true;
      actionBtn.disabled = true;
      
      try {
        const now = Date.now();
        
        // Save to Firebase first
        await timerRef.set({
          startTime: now,
          settings: state
        });
        
        // Only set local state after successful save
        startTime = now;
        actionBtn.textContent = "‚Ü∫";
        actionBtn.classList.add("running");
        
        card.classList.remove("pulse");
        void card.offsetWidth;
        card.classList.add("pulse");
      } catch (err) {
        console.error("Failed to start timer:", err);
        showError("Failed to start timer. Please try again.");
        startTime = null;
        actionBtn.textContent = "Start";
        actionBtn.classList.remove("running");
      } finally {
        isOperating = false;
        actionBtn.disabled = false;
      }
    }

    async function resetTimer() {
      if (isOperating) return;
      
      isOperating = true;
      actionBtn.disabled = true;
      
      try {
  // Clear display first for immediate feedback
  document.querySelectorAll('.unit').forEach(u => u.classList.remove('visible'));
  
  // Clear all numbers and bars completely
  setNumber("day", 0);
  setNumber("hr", 0);
  setNumber("min", 0);
  setNumber("sec", 0);
  
  // Reset all progress bars to 0%
  updateBar("dayBar", 0);
  updateBar("hrBar", 0);
  updateBar("minBar", 0);
  updateBar("secBar", 0);
  
  // Clear prev values for clean restart
  prevValues = { day: '', hr: '', min: '', sec: '' };
        
        // Save to Firebase
        await timerRef.set({
          settings: state
        });
        
        // Update local state after successful save
        startTime = null;
        actionBtn.textContent = "Start";
        actionBtn.classList.remove("running");
      } catch (err) {
        console.error("Failed to reset timer:", err);
        showError("Failed to reset timer. Please try again.");
      } finally {
        isOperating = false;
        actionBtn.disabled = false;
      }
    }

    /* ================================
       12. DISPLAY FUNCTIONS
       ================================ */
    function setNumber(containerId, newValue) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      const oldValue = prevValues[containerId];
const newStr = String(newValue);
      const oldStr = String(oldValue);

      if (oldValue === '' || oldStr.length !== newStr.length) {
        container.innerHTML = '';
        for (let i = 0; i < newStr.length; i++) {
          const digit = document.createElement('span');
          digit.className = 'digit';
          digit.innerHTML = `<span class="digit-inner">${newStr[i]}</span>`;
          container.appendChild(digit);
        }
      } else {
        for (let i = 0; i < newStr.length; i++) {
          if (oldStr[i] !== newStr[i]) {
            const digit = container.children[i];
            if (!digit) continue;
            
            if (state.numberAnim === 'flip') {
              // Clear any existing animation
              digit.classList.remove('flipping');
              
              // Remove all old digit-inner elements except the first one
              const inners = digit.querySelectorAll('.digit-inner');
              for (let j = 1; j < inners.length; j++) {
                inners[j].remove();
              }
              
              const oldInner = digit.querySelector('.digit-inner');
              if (!oldInner) continue;
              
              oldInner.classList.remove('old', 'new');
              oldInner.classList.add('old');
              
              const newInner = document.createElement('span');
              newInner.className = 'digit-inner new';
              newInner.textContent = newStr[i];
              digit.appendChild(newInner);
              
              // Force reflow to restart animation
              void digit.offsetWidth;
              digit.classList.add('flipping');
              
              setTimeout(() => {
                if (digit.contains(oldInner)) {
                  digit.classList.remove('flipping');
                  oldInner.remove();
                  newInner.classList.remove('new');
                }
              }, 600);
            } else {
              const inner = digit.querySelector('.digit-inner');
              if (inner) inner.textContent = newStr[i];
            }
          }
        }
      }

      prevValues[containerId] = newValue;
    }

function updateBar(barId, percentage) {
  const bar = document.getElementById(barId);
  if (!bar) return;
  
  const parentBar = bar.parentElement;
  
  // Seconds bar needs instant updates for smooth millisecond animation
  // Other bars use smooth transitions for seamless filling and resetting
  if (barId === 'secBar') {
    bar.style.transition = 'none';
  } else {
    bar.style.transition = '';
  }
  
// Clear any stuck inline styles and update fill width
parentBar.style.background = '';
bar.style.width = percentage + "%";

  // Handle percentage display
  let percentSpan = parentBar.querySelector('.bar-percentage');
  
  if (state.showPercentage) {
    // Create percentage span if it doesn't exist
    if (!percentSpan) {
      percentSpan = document.createElement('span');
      percentSpan.className = 'bar-percentage';
      parentBar.appendChild(percentSpan);
    }
    // Update percentage text
    percentSpan.textContent = Math.round(percentage) + '%';
  } else {
    // Remove percentage span if it exists
    if (percentSpan) {
      percentSpan.remove();
    }
  }
}

function updateDisplay() {
      if (!startTime) {
        return;
      }

      // Get total milliseconds for subsecond precision
      const totalMs = Math.max(0, Date.now() - startTime);
      const diff = Math.floor(totalMs / 1000); // Total seconds

      const sec = diff % 60;
      const totalMinutes = Math.floor(diff / 60);
      const min = totalMinutes % 60;
      const totalHours = Math.floor(totalMinutes / 60);
      const hr = totalHours % 24;
      const day = Math.floor(totalHours / 24);

      // Get milliseconds within current second for smooth second bar animation
      const msInCurrentSecond = totalMs % 1000;

      const dayUnit = document.getElementById("dayUnit");
      const hrUnit = document.getElementById("hrUnit");
      const minUnit = document.getElementById("minUnit");
      const secUnit = document.getElementById("secUnit");

      // Use the visibility settings from state instead of automatic detection
      const unitsToShow = [];
      
      // Check user preferences for visibility
      if (state.visibleUnits && state.visibleUnits.day) {
        unitsToShow.push('day');
      }
      if (state.visibleUnits && state.visibleUnits.hr) {
        unitsToShow.push('hr');
      }
      if (state.visibleUnits && state.visibleUnits.min) {
        unitsToShow.push('min');
      }
      if (state.visibleUnits && state.visibleUnits.sec) {
        unitsToShow.push('sec');
      }
      
      // If no units are checked, default to showing seconds
      if (unitsToShow.length === 0) {
        unitsToShow.push('sec');
      }

      // Day Display - Number shows days, bar shows progress through current 24-hour cycle
      if (unitsToShow.includes('day')) {
        dayUnit.classList.add("visible");
        setNumber("day", day);
        // Bar fills based on hours (0-24 hours = 0-100%)
        updateBar("dayBar", (hr / 24) * 100);
      } else {
        dayUnit.classList.remove("visible");
      }
      
      // Hour Display - Number shows hours, bar shows progress through current 60-minute cycle
      if (unitsToShow.includes('hr')) {
        hrUnit.classList.add("visible");
        setNumber("hr", hr);
        // Bar fills based on minutes (0-60 minutes = 0-100%)
        updateBar("hrBar", (min / 60) * 100);
      } else {
        hrUnit.classList.remove("visible");
      }

      // Minute Display - Number shows minutes, bar shows progress through current 60-second cycle
      if (unitsToShow.includes('min')) {
        minUnit.classList.add("visible");
        setNumber("min", min);
        // Bar fills based on seconds (0-60 seconds = 0-100%)
        updateBar("minBar", (sec / 60) * 100);
      } else {
        minUnit.classList.remove("visible");
      }

      // Second Display - Number shows seconds, bar shows progress through current 1000ms cycle
      if (unitsToShow.includes('sec')) {
        secUnit.classList.add("visible");
        setNumber("sec", sec);
        // Bar fills based on milliseconds (0-1000ms = 0-100%) for smooth animation
        updateBar("secBar", (msInCurrentSecond / 1000) * 100);
      } else {
        secUnit.classList.remove("visible");
      }
    }
    /* ================================
       13. BUTTON CLICK HANDLER
       ================================ */
    actionBtn.onclick = () => {
      if (startTime === null) {
        startTimer();
      } else {
        resetTimer();
      }
    };
    /* ================================
       14. INIT
       ================================ */
    loadTimer();
    
    function loop() {
      updateDisplay();
      requestAnimationFrame(loop);
    }
    
    loop();
  </script>
</body>
</html>
